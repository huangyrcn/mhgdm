# MHGDM Project Navigation Guide

## Data Loading System

### Optimized Data Utilities
- **Primary data loader**: [utils/data_utils_optimized.py](mdc:utils/data_utils_optimized.py) - High-performance data loading with 2-3x speedup
- **Graph utilities**: [utils/graph_utils.py](mdc:utils/graph_utils.py) - Core graph manipulation functions
- **Legacy loader**: [utils/data_utils.py](mdc:utils/data_utils.py) - Original data loading implementation

### Dataset Configurations
Dataset configs are in `configs/data/` directory:
- [configs/data/ENZYMES.yaml](mdc:configs/data/ENZYMES.yaml) - 600 graphs, batch_size: 256
- [configs/data/Letter_high.yaml](mdc:configs/data/Letter_high.yaml) - ~2K graphs, batch_size: 128  
- [configs/data/Reddit.yaml](mdc:configs/data/Reddit.yaml) - 1.1K graphs, large graphs (3782 nodes max)
- [configs/data/TRIANGLES.yaml](mdc:configs/data/TRIANGLES.yaml) - 2K graphs, batch_size: 128

## Key Architecture Components

## Three-Stage Training Architecture

### ğŸ¯ Training Modules
1. **Stage 1 - Hyperbolic VAE Pretraining**: [vae_trainer.py](mdc:vae_trainer.py) 
   - Trains hyperbolic graph autoencoder
   - Supports PoincareBall, Lorentz manifolds
   - Entry: `python vae_trainer.py training_mode=ae`

2. **Stage 2 - Score Model Training**: [score_trainer.py](mdc:score_trainer.py)
   - Trains generative score networks (X + Adj)
   - Uses pretrained VAE encoder
   - Entry: `python score_trainer.py ae_path=<vae_checkpoint>`

3. **Stage 3 - Meta-Learning**: [meta_test.py](mdc:meta_test.py)
   - Data augmentation + classifier head fine-tuning
   - Few-shot learning evaluation
   - Entry: `python meta_test.py vae_ckpt_path=<vae> score_ckpt_path=<score>`

### ğŸ”§ Experiment Management
- **Unified Manager**: [experiment_manager.py](mdc:experiment_manager.py) - Orchestrates all three stages
- **Experiment Configs**: [configs/experiments/](mdc:configs/experiments/) - Complete experiment configurations  
- **Usage**: `python experiment_manager.py --config configs/experiments/enzymes_three_stage.yaml`

### Training Pipeline
- **Legacy trainer**: [trainer.py](mdc:trainer.py) - Original training entry point

### Models
Core models are in `models/` directory:
- Score networks for adjacency matrices and node features
- Graph VAE implementations
- All models integrate with [utils/graph_utils.py](mdc:utils/graph_utils.py)

## Data Loading Best Practices

### Using Optimized Data Loader
```python
from utils.data_utils_optimized import MyDatasetOptimized

# Enable optimizations in config
data_config.enable_optimization = True
data_config.lazy_tensor_conversion = False  # or True for memory efficiency

# Create dataset with FSL support
dataset = MyDatasetOptimized(data_config, fsl_task_config)
```

### Configuration Requirements
All dataset configs must include:
- `name`: Dataset name matching directory in `datasets/`
- `max_node_num`: Maximum nodes across all graphs
- `max_feat_num`: Feature dimension
- `batch_size`: Training batch size

### Performance Considerations
- **Small datasets** (ENZYMES, TRIANGLES): ~0.2-0.3s load time
- **Medium datasets** (Letter_high): ~0.2s load time  
- **Large datasets** (Reddit): ~90s load time due to 3782 max nodes
- Optimized loader provides 2-3x speedup over legacy version

## File Dependencies
- Data loaders depend on [utils/graph_utils.py](mdc:utils/graph_utils.py) for `graphs_to_tensor`
- All trainers import graph utilities for masking and node operations
- Dataset files must be in `datasets/{name}/{name}.txt` format
- Train/test splits defined in `datasets/{name}/train_test_classes.json`

## Testing Data Loading
To test new datasets or configurations:
1. Ensure dataset files exist in proper structure
2. Create config YAML with correct parameters
3. Test with `MyDatasetOptimized` class
4. Verify FSL task sampling works for few-shot learning scenarios

## Configuration Directories Structure
- `configs/data/`: Dataset configurations
- `configs/model/`: Model architecture configs  
- `configs/train/`: Training hyperparameters
- `configs/fsl_task/`: Few-shot learning task definitions

# MHGDMé¡¹ç›®æ¶æ„å’Œå¼€å‘æŒ‡å—

## é¡¹ç›®æ¦‚è¿°
å¤šé˜¶æ®µåŒæ›²å›¾ç”Ÿæˆæ¨¡å‹é¡¹ç›®ï¼Œé‡‡ç”¨ä¸‰é˜¶æ®µè®­ç»ƒæ¶æ„ï¼šVAEé¢„è®­ç»ƒ â†’ Scoreç½‘ç»œè®­ç»ƒ â†’ å…ƒå­¦ä¹ æµ‹è¯•

## ä¸‰é˜¶æ®µè®­ç»ƒæ¶æ„

### Stage 1: VAEé¢„è®­ç»ƒ
**è®­ç»ƒå™¨**: [vae_trainer.py](mdc:vae_trainer.py) - `VAETrainer`ç±»  
**ç›®æ ‡**: è®­ç»ƒåŒæ›²å›¾å˜åˆ†è‡ªç¼–ç å™¨ï¼Œå­¦ä¹ å›¾çš„æ½œåœ¨è¡¨ç¤º
- æ”¯æŒåŒæ›²æµå½¢ï¼ˆPoincareBall, Lorentzï¼‰å’Œæ¬§å‡ é‡Œå¾—ç©ºé—´
- é›†æˆå…ƒæµ‹è¯•ç›‘æ§å’Œæ—©åœæœºåˆ¶
- é…ç½®è·¯å¾„: `configs/vae/` ç›®å½•
- è¾“å‡ºï¼šç¼–ç å™¨æ£€æŸ¥ç‚¹ (åŒ…å«`encoder_state_dict`)

### Stage 2: Scoreç½‘ç»œè®­ç»ƒ  
**è®­ç»ƒå™¨**: [score_trainer.py](mdc:score_trainer.py) - `ScoreTrainer`ç±»  
**ç›®æ ‡**: è®­ç»ƒæ‰©æ•£æ¨¡å‹çš„åˆ†æ•°ç½‘ç»œï¼Œå­¦ä¹ å›¾ç”Ÿæˆè¿‡ç¨‹
- åŠ è½½é¢„è®­ç»ƒVAEç¼–ç å™¨ï¼ˆå†»ç»“ï¼‰
- è®­ç»ƒXç½‘ç»œï¼ˆèŠ‚ç‚¹ç‰¹å¾ï¼‰å’ŒAdjç½‘ç»œï¼ˆé‚»æ¥çŸ©é˜µï¼‰çš„åˆ†æ•°å‡½æ•°
- é›†æˆé‡‡æ ·è´¨é‡è¯„ä¼° ([utils/sampler.py](mdc:utils/sampler.py))
- é…ç½®è·¯å¾„: `configs/score/` ç›®å½•  
- è¾“å‡ºï¼šåˆ†æ•°ç½‘ç»œæ£€æŸ¥ç‚¹ (åŒ…å«`x_state_dict`, `adj_state_dict`)

### Stage 3: å…ƒå­¦ä¹ æµ‹è¯•
**æµ‹è¯•å™¨**: [meta_test.py](mdc:meta_test.py) - `MetaTestTrainer`ç±»  
**ç›®æ ‡**: å°‘æ ·æœ¬å­¦ä¹ è¯„ä¼°ï¼ŒéªŒè¯å­¦åˆ°çš„è¡¨ç¤ºè´¨é‡
- åŠ è½½VAEç¼–ç å™¨æå–å›¾ç‰¹å¾
- ç®€å•åˆ†ç±»å™¨å¿«é€Ÿé€‚åº”æ–°ä»»åŠ¡  
- æ”¯æŒN-way K-shotè¯„ä¼°åè®®
- é…ç½®ï¼šç¡¬ç¼–ç å‚æ•°ä¿æŒç®€æ´

### ç»Ÿä¸€æ‰§è¡Œ
**ä¸»å…¥å£**: [run_three_stage.py](mdc:run_three_stage.py)  
æŒ‰é¡ºåºæ‰§è¡Œä¸‰é˜¶æ®µè®­ç»ƒï¼Œè‡ªåŠ¨ç®¡ç†æ£€æŸ¥ç‚¹è·¯å¾„ä¼ é€’ã€‚

## ä»£ç æ¶æ„æ¨¡å¼

### è®­ç»ƒå™¨åŸºç±»æ¨¡å¼
æ‰€æœ‰è®­ç»ƒå™¨éµå¾ªç»Ÿä¸€çš„åˆå§‹åŒ–æ¨¡å¼ï¼š
```python
class Trainer:
    def __init__(self, config_path, *checkpoints):
        # 1. é…ç½®åŠ è½½
        self.config = load_config(config_path)
        
        # 2. åŸºç¡€è®¾ç½®  
        self.device = load_device(self.config)
        load_seed(self.config.seed)
        
        # 3. wandbåˆå§‹åŒ–
        self._init_wandb()
        
        # 4. æ•°æ®åŠ è½½
        self.dataset = MyDataset(...)
        
        # 5. æ¨¡å‹åˆå§‹åŒ–
        self._init_model()
```

### å‘½åçº¦å®š
- **ç§æœ‰æ–¹æ³•**: `_` å‰ç¼€ (å¦‚ `_init_wandb()`, `_load_encoder()`)
- **æ£€æŸ¥ç‚¹ç±»å‹**: `best`, `final`, `current`
- **é…ç½®å¯¹è±¡**: ä½¿ç”¨ `SimpleNamespace` ä¼ é€’
- **æ—¥å¿—è¾“å‡º**: ä¼˜å…ˆä½¿ç”¨ `tqdm.write()`, å…¶æ¬¡ `print()`

### é”™è¯¯å¤„ç†æ¨¡å¼
- **é™çº§ç­–ç•¥**: å¤æ‚åŠŸèƒ½å¤±è´¥æ—¶å›é€€åˆ°ç®€å•ç‰ˆæœ¬
- **è¯¦ç»†è­¦å‘Š**: å¤±è´¥æ—¶è¾“å‡ºæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- **Try-catchåŒ…è£…**: æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ“ä½œéƒ½æœ‰å¼‚å¸¸å¤„ç†

## æ ¸å¿ƒå·¥å…·æ¨¡å—

### é…ç½®ç®¡ç†
- [utils/config_utils.py](mdc:utils/config_utils.py) - `load_config()`, `save_config()`
- [configs/](mdc:configs/) - åˆ†å±‚é…ç½®æ–‡ä»¶ï¼Œæ–°æ—§æ ¼å¼å…¼å®¹

### æ•°æ®å¤„ç†ç³»ç»Ÿ
- [utils/data_utils.py](mdc:utils/data_utils.py) - `MyDataset`ç±»ï¼ŒFSLä»»åŠ¡é‡‡æ ·
- [utils/graph_utils.py](mdc:utils/graph_utils.py) - `node_flags()`, `mask_adjs()`, `quantize()`

### æ¨¡å‹ç»„ä»¶
- [models/GraphVAE.py](mdc:models/GraphVAE.py) - åŒæ›²å›¾å˜åˆ†è‡ªç¼–ç å™¨
- [models/Decoders.py](mdc:models/Decoders.py) - `Classifier`è§£ç å™¨
- [utils/loader.py](mdc:utils/loader.py) - `load_model_from_ckpt()`, `load_sampling_fn()`

### é‡‡æ ·åŸºç¡€è®¾æ–½  
- [utils/solver.py](mdc:utils/solver.py) - `get_pc_sampler()` æ ¸å¿ƒé‡‡æ ·ç®—æ³•
- [utils/sampler.py](mdc:utils/sampler.py) - `Sampler`ç±»ï¼Œè®­ç»ƒæœŸé—´è´¨é‡è¯„ä¼°

### å‡ ä½•è®¡ç®—
- [utils/manifolds_utils.py](mdc:utils/manifolds_utils.py) - åŒæ›²å‡ ä½•æ“ä½œ
- [utils/sde_lib.py](mdc:utils/sde_lib.py) - éšæœºå¾®åˆ†æ–¹ç¨‹å®šä¹‰

## æ•°æ®é›†å’Œé…ç½®

### æ”¯æŒçš„æ•°æ®é›†
åœ¨ [datasets/](mdc:datasets/) ç›®å½•ï¼š
- **ENZYMES** (600å›¾) - è›‹ç™½è´¨ç»“æ„ï¼Œbatch_size: 256
- **Letter_high** (~2Kå›¾) - å­—æ¯è¯†åˆ«ï¼Œbatch_size: 128  
- **Reddit** (1.1Kå›¾) - ç¤¾äº¤ç½‘ç»œï¼Œå¤§å›¾åœºæ™¯
- **TRIANGLES** (2Kå›¾) - å‡ ä½•å›¾å½¢

### é…ç½®æ–‡ä»¶ç»“æ„
```
configs/
  â”œâ”€â”€ letter_high_poincare.yaml    # ä¸»é…ç½®æ–‡ä»¶ç¤ºä¾‹
  â”œâ”€â”€ data/                        # æ•°æ®é›†é…ç½®
  â”œâ”€â”€ old/                         # å†å²é…ç½®å‚è€ƒ
  â””â”€â”€ experiments/                 # å®Œæ•´å®éªŒé…ç½®
```

### é…ç½®å…¼å®¹æ€§
- æ”¯æŒæ–°æ—§ä¸¤ç§é…ç½®æ ¼å¼ (`vae.encoder` vs `encoder`)
- ä½¿ç”¨ `SimpleNamespace` ç¡®ä¿å±æ€§è®¿é—®ä¸€è‡´æ€§
- è‡ªåŠ¨å¡«å……ç¼ºå¤±å­—æ®µï¼Œç¡®ä¿å‘åå…¼å®¹

## å¼€å‘æœ€ä½³å®è·µ

### ä»£ç è´¨é‡è¦æ±‚
- **å¯è¯»æ€§ä¼˜å…ˆ**: é¿å…è¿‡åº¦å·¥ç¨‹åŒ–ï¼Œä¿æŒç®€æ´
- **éµå¾ªç°æœ‰çº¦å®š**: ä½¿ç”¨é¡¹ç›®ç»Ÿä¸€çš„å‘½åå’Œç»“æ„æ¨¡å¼  
- **é”™è¯¯å¤„ç†**: è€ƒè™‘é™çº§ç­–ç•¥å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **æ–‡æ¡£æ³¨é‡Š**: å¤æ‚é€»è¾‘æä¾›æ¸…æ™°è¯´æ˜

### æµ‹è¯•å’Œè°ƒè¯•
- ä½¿ç”¨å°æ•°æ®é›†(ENZYMES)å¿«é€ŸéªŒè¯
- å…³æ³¨æ£€æŸ¥ç‚¹æ ¼å¼å…¼å®¹æ€§  
- éªŒè¯è®¾å¤‡ç®¡ç†å’Œå†…å­˜ä½¿ç”¨
- æ£€æŸ¥wandbæ—¥å¿—å®Œæ•´æ€§

### æ–°åŠŸèƒ½å¼€å‘æµç¨‹
1. **ç†è§£ç°æœ‰æ¶æ„** - åˆ†æç›¸å…³æ¨¡å—å’Œä¾èµ–å…³ç³»
2. **æœ€å°å¯è¡Œå®ç°** - åŸºäºç°æœ‰æ¨¡å¼è¿›è¡Œå¢é‡ä¿®æ”¹
3. **ä¿æŒä¸€è‡´æ€§** - éµå¾ªå‘½åçº¦å®šå’Œé”™è¯¯å¤„ç†æ¨¡å¼
4. **æµ‹è¯•é›†æˆ** - ç¡®ä¿ä¸ä¸‰é˜¶æ®µæµç¨‹æ— ç¼é›†æˆ
